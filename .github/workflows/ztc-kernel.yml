name: Melt Kernel Build with SukiSU
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:

jobs:
  build-kernel-sukisu-susfs:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-swapfile: 'true'
          remove-cached-tools: 'false'
          verbose: 'true'

      - name: 设定 CONFIG 环境变量
        run: |
          CONFIG="android12-5.10-lts"
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          echo "CONFIG set to: $CONFIG"

      - name: 安装依赖
        run: sudo apt update && sudo apt upgrade -y && sudo apt install -y ccache python3 git curl build-essential libssl-dev bison flex libelf-dev dwarves dos2unix

      - name: 配置 ccache
        run: |
          mkdir -p ~/.cache/bazel
          ccache --version
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: 配置 Git
        run: |
          git config --global user.name "zzh20188"
          git config --global user.email "BuildGkiKernel@gmail.com"
      
      - name: 安装仓库工具
        run: |
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/./git-repo/repo" >> $GITHUB_ENV

      - name: 克隆 AnyKernel3
        run: |
          echo "Cloning AnyKernel3..."
          ANYKERNEL_BRANCH="gki-2.0"
          git clone https://github.com/WildPlusKernel/AnyKernel3.git -b "$ANYKERNEL_BRANCH"

      - name: 克隆 Melt Kernel 源码
        run: |
          echo "Cloning Melt Kernel source..."
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          
          # 克隆 Melt Kernel 源码替代 ZTC 内核
          git clone https://github.com/Pzqqt/android_kernel_xiaomi_marble.git --depth=1 --branch melt-rebase .
          
          # 设置构建环境
          echo "KERNEL_SOURCE=$GITHUB_WORKSPACE/$CONFIG" >> $GITHUB_ENV

      - name: 检查内核源码结构
        run: |
          echo "检查内核源码目录结构..."
          cd "$CONFIG"
          ls -la
          find . -name "build.sh" -type f
          find . -name "build*.sh" -type f
          echo "构建系统文件列表:"
          ls -la build/ 2>/dev/null || echo "没有build目录"

      - name: 获取 SukiSU & SUSFS 版本
        id: get_versions
        run: |
          echo "This is the SukiSU variant"
          
          # 计算SukiSU版本号
          git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git KernelSU
          cd KernelSU
          KSU_GIT_VERSION=$(git rev-list --count HEAD)
          KSU_VERSION=$((40000 + KSU_GIT_VERSION - 2815))
          echo "SukiSU Version: $KSU_VERSION"
          echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV

          # 计算SUSFS版本号
          INFO="https://gitlab.com/simonpunk/susfs4ksu/-/raw/gki-android12-5.10/ksu_module_susfs/module.prop?ref_type=heads"
          SUS_VERSION=$(curl -s "$INFO" | awk -F '=' '$1 == "version" { print $2 }' | tr -d '[:space:]')
          echo "SUSFS Version: $SUS_VERSION"
          echo "SUS_VERSION=$SUS_VERSION" >> $GITHUB_ENV

          echo "kversion=$KSU_VERSION" >> $GITHUB_OUTPUT
          echo "sversion=$SUS_VERSION" >> $GITHUB_OUTPUT

      - name: 应用 SukiSU 和 SUSFS 补丁
        run: |
          echo "Applying SukiSU and SUSFS patches..."
          cd "$CONFIG"
          
          # 克隆 SukiSU 到内核源码目录
          git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git KernelSU
          
          # 应用 SukiSU 补丁
          cd KernelSU
          if [ -f "kernel.patch" ]; then
            echo "Applying kernel.patch..."
            cd ..
            patch -p1 < KernelSU/kernel.patch || echo "Patch application completed or no patch needed"
          else
            echo "No kernel.patch found, skipping patch application"
          fi
          
          # 应用 SUSFS 补丁 [1](@ref)
          cd "$CONFIG"
          branch="gki-android12-5.10"
          
          # 下载 SUSFS 补丁文件 [2](@ref)
          wget "https://gitlab.com/simonpunk/susfs4ksu/-/raw/$branch/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch?ref_type=heads" -O "KernelSU/10_enable_susfs_for_ksu.patch"
          wget "https://gitlab.com/simonpunk/susfs4ksu/-/raw/$branch/kernel_patches/50_add_susfs_in_$branch.patch?ref_type=heads" -O "50_add_susfs_in_$branch.patch"
          wget "https://gitlab.com/simonpunk/susfs4ksu/-/raw/$branch/kernel_patches/fs/susfs.c?ref_type=heads" -O "fs/susfs.c"
          wget "https://gitlab.com/simonpunk/susfs4ksu/-/raw/$branch/kernel_patches/include/linux/susfs.h?ref_type=heads" -O "include/linux/susfs.h"
          
          # 应用 SUSFS 补丁 [1](@ref)
          cd KernelSU
          patch -p1 < 10_enable_susfs_for_ksu.patch || echo "SUSFS for KSU patch might have issues"
          cd ..
          patch -p1 < "50_add_susfs_in_$branch.patch" || echo "SUSFS kernel patch might have issues"

      - name: 配置内核功能
        run: |
          echo "Configuring kernel features..."
          cd "$CONFIG"
          
          # 配置 SukiSU 相关选项
          echo "CONFIG_KPROBES=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_HAVE_KPROBES=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPROBE_EVENTS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_OVERLAY_FS=y" >> arch/arm64/configs/gki_defconfig
          
          # 配置 SUSFS [1](@ref)
          echo "CONFIG_SUSFS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/gki_defconfig
          
          # 配置 KPM (Kernel Patch Manager)
          echo "CONFIG_KPM=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPM_DEBUG=y" >> arch/arm64/configs/gki_defconfig
          
          # 配置 ZRAM 算法
          echo "CONFIG_ZRAM=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ZRAM_WRITEBACK=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_ZSMALLOC=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4HC=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZO=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_ZSTD=y" >> arch/arm64/configs/gki_defconfig

      - name: 配置构建环境
        run: |
          echo "Setting up build environment..."
          cd "$CONFIG"
          
          # 检查构建脚本是否存在并设置权限
          if [ -f "build.sh" ]; then
            chmod +x build.sh
            dos2unix build.sh 2>/dev/null || echo "dos2unix not available or not needed"
          fi
          
          # 下载编译工具链
          curl -LSs "https://github.com/zzh20188/ZTC-Kenel-Build/releases/download/clang/clang-r563880.tar.gz" -o clang-r563880.tar.gz
          mkdir -p prebuilts/clang/host/linux-x86/clang-r563880
          tar -xzvf clang-r563880.tar.gz -C prebuilts/clang/host/linux-x86/clang-r563880
          
          # 设置编译工具路径
          echo "CLANG_PREBUILT_BIN=prebuilts/clang/host/linux-x86/clang-r563880/bin" >> build.config.common

      - name: 构建内核
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 90
          max_attempts: 3
          retry_on: timeout
          command: |
            set -e
            set -x
            cd "$CONFIG"
            echo "Building Melt Kernel with SukiSU and SUSFS..."
            echo "当前工作目录: $(pwd)"
            echo "目录内容:"
            ls -la
            
            # 检查构建脚本并设置执行权限 [4](@ref)
            if [ -f "build/build.sh" ]; then
                echo "使用 build/build.sh"
                chmod +x build/build.sh
                LTO=thin KCFLAGS="-O3" BUILD_CONFIG=build.config.gki.aarch64 ./build/build.sh CC=clang || exit 1
            elif [ -f "build.sh" ]; then
                echo "使用根目录的 build.sh"
                chmod +x build.sh
                LTO=thin KCFLAGS="-O3" BUILD_CONFIG=build.config.gki.aarch64 ./build.sh CC=clang || exit 1
            else
                echo "错误: 未找到构建脚本"
                find . -name "*.sh" -type f
                exit 1
            fi

      - name: 创建Boot镜像
        run: |
          echo "Creating boot images..."
          mkdir -p bootimgs
          
          # 复制生成的镜像文件
          if [ -d "./$CONFIG/out" ]; then
            find "./$CONFIG/out" -name "Image" -exec cp {} ./bootimgs/ \; || echo "Image copy failed"
            find "./$CONFIG/out" -name "Image.lz4" -exec cp {} ./bootimgs/ \; || echo "Image.lz4 copy failed"
            find "./$CONFIG/out" -name "Image" -exec cp {} ./ \; || echo "Image copy to root failed"
            find "./$CONFIG/out" -name "Image.lz4" -exec cp {} ./ \; || echo "Image.lz4 copy to root failed"
          fi

          # 创建 gzip 压缩版本
          if [ -f "./Image" ]; then
            gzip -n -k -f -9 ./Image > ./Image.gz || echo "Gzip failed"
            cp ./Image.gz ./bootimgs/ || echo "Image.gz copy failed"
          fi

      - name: 准备AnyKernel3
        run: |
          echo "Preparing AnyKernel3..."
          if [ -f "./Image" ]; then
            cp ./Image ./AnyKernel3/Image || echo "Failed to copy Image to AnyKernel3"
          elif [ -f "./bootimgs/Image" ]; then
            cp ./bootimgs/Image ./AnyKernel3/Image || echo "Failed to copy Image from bootimgs"
          else
            echo "Image file not found for AnyKernel3"
            ls -la ./
            ls -la ./bootimgs/ 2>/dev/null || echo "bootimgs directory not found"
          fi

      - name: 添加 SukiSU 管理器
        id: add_sukisu
        continue-on-error: true
        run: |
          REPO="SukiSU-Ultra/SukiSU-Ultra"
          FILENAME="build-manager.yml"
          KSUM="manager"
          
          NUMBER=0
          DOWNLOAD_URL=""

          echo "Searching for SukiSU manager build..."
          while [ $NUMBER -lt 9 ]; do
            echo "Checking build #$NUMBER..."
            
            BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/workflows/$FILENAME/runs?status=success" | \
              jq -r ".workflow_runs[$NUMBER].id // empty")
            
            if [ -z "$BUILD_ID" ]; then
              echo "No build found at index $NUMBER"
              NUMBER=$((NUMBER + 1))
              continue
            fi

            echo "Found build ID: $BUILD_ID"
            ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/runs/$BUILD_ID/artifacts")

            ARTIFACT_NAME=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name | contains("manager")) | .name // empty' | head -1)
            
            if [ -n "$ARTIFACT_NAME" ]; then
              DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .archive_download_url")
              echo "Found manager: $ARTIFACT_NAME"
              break
            fi
            
            NUMBER=$((NUMBER + 1))
          done

          if [ -n "$DOWNLOAD_URL" ]; then
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "SukiSU-Manager-${{ env.KSU_VERSION }}.zip" "$DOWNLOAD_URL"
            unzip -o "SukiSU-Manager-${{ env.KSU_VERSION }}.zip" || echo "Unzip failed or no files to extract"
            rm -f "SukiSU-Manager-${{ env.KSU_VERSION }}.zip"
            echo "SukiSU manager downloaded successfully"
          else
            echo "Failed to find SukiSU manager after $NUMBER attempts"
          fi

      - name: 添加 SUSFS 模块
        id: add_SUSFS
        continue-on-error: true
        run: |
          echo "Downloading SUSFS module..."
          BUILD_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/workflows/build.yml/runs?status=success" | \
            jq -r '.workflow_runs[0].id // empty')
          
          if [ -n "$BUILD_ID" ]; then
            ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$BUILD_ID/artifacts")
            
            DOWNLOAD_URL=$(echo "$ARTIFACTS" | jq -r '.artifacts[0].archive_download_url // empty')
            ARTIFACT_NAME=$(echo "$ARTIFACTS" | jq -r '.artifacts[0].name // empty')
            
            if [ -n "$DOWNLOAD_URL" ]; then
              echo "Downloading SUSFS: $ARTIFACT_NAME"
              curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -o "susfs-module.zip" "$DOWNLOAD_URL"
              mkdir -p susfs-module
              unzip -o "susfs-module.zip" -d susfs-module/ || echo "Unzip failed"
              rm -f "susfs-module.zip"
              echo "SUSFS module downloaded successfully"
            else
              echo "Failed to get SUSFS download URL"
            fi
          else
            echo "No successful SUSFS builds found"
          fi

      - name: 上传编译资产
        uses: actions/upload-artifact@v4
        with:
          name: Melt-SukiSU-Build-${{ env.KSU_VERSION }}
          path: |
            ./AnyKernel3/*
            ./*.apk
            ./susfs-module/*
            ./bootimgs/*
          retention-days: 7

      - name: 创建发布版本
        if: success()
        run: |
          echo "Build completed successfully!"
          echo "SukiSU Version: ${{ env.KSU_VERSION }}"
          echo "SUSFS Version: ${{ env.SUS_VERSION }}"
          echo "Kernel Source: Melt Kernel (Pzqqt/android_kernel_xiaomi_marble)"
